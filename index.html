<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shiv HD Enterprise - Premium Video Call</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff3b30; --accent: #ffcc00; --bg: #0b0b0b; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Inter', sans-serif; }

        /* 50-50 Professional Camera Split */
        #video-grid { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        .video-box { position: relative; flex: 1; overflow: hidden; background: #000; border-bottom: 2px solid #222; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Floating Labels */
        .live-badge { position: absolute; top: 15px; left: 15px; background: red; color: white; padding: 2px 10px; border-radius: 5px; font-size: 10px; font-weight: bold; animation: blink 1s infinite; }
        .name-tag { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.6); color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; backdrop-filter: blur(5px); }

        /* Chat & History System (Server-Side) */
        #chat-section { position: absolute; bottom: 90px; left: 15px; right: 15px; height: 200px; display: flex; flex-direction: column; pointer-events: none; }
        #messages { flex: 1; overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .msg-bubble { background: rgba(255,255,255,0.15); color: white; padding: 8px 12px; border-radius: 15px; font-size: 13px; max-width: 75%; backdrop-filter: blur(10px); animation: fadeIn 0.3s; }
        .history-msg { color: #aaa; font-style: italic; font-size: 11px; }

        /* Powerful Control Bar */
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 100; }
        .main-btn { width: 65px; height: 65px; border-radius: 50%; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255,59,48,0.5); }
        .gift-icon { font-size: 24px; background: rgba(255,204,0,0.2); border: 1px solid var(--accent); width: 45px; height: 45px; border-radius: 50%; color: var(--accent); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="video-grid">
    <div class="video-box">
        <div class="live-badge">STRANGER HD</div>
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="name-tag" id="partner-name">Waiting...</div>
    </div>
    <div class="video-box">
        <div class="live-badge" style="background:green">YOU</div>
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="name-tag">You (HD Live)</div>
    </div>
</div>

<div id="chat-section">
    <div id="messages"></div>
    <div style="display: flex; gap: 10px; pointer-events: auto;">
        <input type="text" id="chatInput" placeholder="Type a message..." style="flex:1; border-radius: 25px; border:none; padding:12px; background:rgba(255,255,255,0.2); color:white; outline:none;">
        <button onclick="sendMsg()" style="background:var(--accent); border:none; border-radius:50%; width:40px; height:40px; cursor:pointer;">âž”</button>
    </div>
</div>

<div class="controls">
    <div class="gift-icon" onclick="sendGift('ðŸŒ¹')">ðŸŒ¹</div>
    <button class="main-btn" onclick="nextMatch()">NEXT</button>
    <div class="gift-icon" onclick="sendGift('ðŸ‘‘')">ðŸ‘‘</div>
</div>

<script>
    const socket = io("https://live-server-lrw7.onrender.com"); // Aapka Render Server Link
    let myPeer, myStream, partnerPeerId, currentRoom;

    // Full HD Camera Logic (Battery Optimized)
    async function startCamera() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { max: 30 } }, 
                audio: true 
            });
            document.getElementById('localVideo').srcObject = myStream;
            initPeer();
        } catch (err) { alert("Camera Permission Needed for HD!"); }
    }

    function initPeer() {
        myPeer = new Peer();
        myPeer.on('open', id => {
            socket.emit('join-shiv-network', { name: "Guest_" + id.slice(0,4) });
        });

        myPeer.on('call', call => {
            call.answer(myStream);
            call.on('stream', stream => {
                document.getElementById('remoteVideo').srcObject = stream;
            });
        });
    }

    // Fast Matching Logic (4000 Users Optimized)
    socket.on('match-ready', data => {
        partnerPeerId = data.partnerId;
        currentRoom = data.room;
        document.getElementById('partner-name').innerText = "Stranger Connected";
        
        const call = myPeer.call(partnerPeerId, myStream);
        call.on('stream', stream => {
            document.getElementById('remoteVideo').srcObject = stream;
        });
    });

    // Server-Side Chat & History
    function sendMsg() {
        const input = document.getElementById('chatInput');
        if(input.value && partnerPeerId) {
            const data = { to: partnerPeerId, msg: input.value, from: "You" };
            socket.emit('message', data);
            displayMessage("You", input.value);
            input.value = "";
        }
    }

    socket.on('message-receive', data => {
        displayMessage("Stranger", data.msg);
    });

    function displayMessage(user, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg-bubble';
        msgDiv.innerHTML = `<b>${user}:</b> ${text}`;
        document.getElementById('messages').appendChild(msgDiv);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    // Gift Logic
    function sendGift(type) {
        if(partnerPeerId) socket.emit('send-gift', { to: partnerPeerId, giftType: type });
    }

    function nextMatch() { location.reload(); }

    startCamera();
</script>
</body>
</html>

